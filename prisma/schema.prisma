// Datasource uses PostgreSQL for deployment readiness.

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

enum WorkspaceRole {
  admin
  editor
  reviewer
  viewer
}

enum UiLocale {
  ja
  en
}

enum EntityType {
  nation
  faction
  character
  location
  building
  item
  event
  map
  concept
}

enum EntityStatus {
  draft
  in_review
  approved
  deprecated
}

enum RevisionStatus {
  draft
  submitted
  approved
  rejected
}

enum ArticleTargetType {
  base
  overlay
}

enum TruthFlag {
  canonical
  rumor
  mistaken
  propaganda
  unknown
}

enum TimelineType {
  world_history
  game_storyline
  dev_meta
}

enum ViewpointType {
  player
  faction
  character
  omniscient
}

enum EventType {
  battle
  travel
  political
  diplomatic
  discovery
  ritual
  disaster
  economic
  cultural
  mystery
  other
}

enum LocationType {
  capital
  city
  village
  fortress
  dungeon
  ruin
  landmark
  region
  outpost
  camp
  port
  temple
  mine
  gate
  road
  other
}

enum MarkerShape {
  circle
  square
  diamond
  triangle
  hex
  star
}

enum MarkerTarget {
  event
  location
  path
}

enum LlmProvider {
  gemini
  codex_cli
}

enum AssetKind {
  image
  file
}

enum ArrowStyle {
  arrow
  dashed
  dotted
}

enum ReviewStatus {
  open
  approved
  rejected
}

enum SourceTargetType {
  entity
  article_revision
  overlay_revision
  map
  asset
  event
  timeline
}

enum EvidenceItemType {
  entity
  asset
  reference
  note
  url
  quote
  frame
}

enum EvidenceLinkStyle {
  line
  arrow
  dashed
  dotted
}

enum ReferenceType {
  url
  book
  pdf
  image
  file
  internal
  other
}

enum CitationTargetType {
  article_revision
  overlay_revision
  entity
  map
  event
  timeline
  board_item
  evidence_board
}

model User {
  id           String            @id @default(cuid())
  email        String            @unique
  name         String?
  passwordHash String
  avatarUrl    String?
  locale       UiLocale          @default(ja)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  memberships              WorkspaceMember[]
  sessions                 Session[]
  createdWorkspaces         Workspace[]        @relation("WorkspaceCreatedBy")
  auditLogs                AuditLog[]          @relation("AuditActor")
  reviewRequests           ReviewRequest[]     @relation("ReviewRequestedBy")
  reviewComments           ReviewComment[]
  reviewAssignments        ReviewAssignment[]
  notifications            Notification[]
  readStates               ReadState[]
  watches                  Watch[]
  articleRevisionsCreated  ArticleRevision[]   @relation("RevisionCreatedBy")
  articleRevisionsApproved ArticleRevision[]   @relation("RevisionApprovedBy")
  entitiesCreated          Entity[]            @relation("EntityCreatedBy")
  entitiesUpdated          Entity[]            @relation("EntityUpdatedBy")
  eventsCreated            Event[]             @relation("EventCreatedBy")
  eventsUpdated            Event[]             @relation("EventUpdatedBy")
  mapsCreated              Map[]               @relation("MapCreatedBy")
  mapsUpdated              Map[]               @relation("MapUpdatedBy")
  assetsCreated            Asset[]             @relation("AssetCreatedBy")      
  llmLogs                  LlmLog[]
  sourceRecordsCreated     SourceRecord[]      @relation("SourceRecordCreatedBy")
  talkThreads              TalkThread[]        @relation("TalkThreadCreatedBy")
  talkComments             TalkComment[]       @relation("TalkCommentCreatedBy")
}

model Session {
  id                 String    @id
  userId             String
  activeWorkspaceId  String?
  createdAt          DateTime  @default(now())
  expiresAt          DateTime

  user      User       @relation(fields: [userId], references: [id])
  workspace Workspace? @relation("WorkspaceSessions", fields: [activeWorkspaceId], references: [id])

  @@index([userId])
}

model Workspace {
  id          String             @id @default(cuid())
  name        String
  slug        String             @unique
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  createdById String?

  createdBy   User?              @relation("WorkspaceCreatedBy", fields: [createdById], references: [id])
  members     WorkspaceMember[]
  sessions    Session[]          @relation("WorkspaceSessions")
  entities    Entity[]
  articles    Article[]
  overlays    ArticleOverlay[]
  revisions   ArticleRevision[]
  viewpoints  Viewpoint[]
  timelines   Timeline[]
  events      Event[]
  eras        Era[]
  chapters    Chapter[]
  maps        Map[]
  mapLayers   MapLayer[]
  mapScenes   MapScene[]
  pins        Pin[]
  paths       Path[]
  assets      Asset[]
  evidenceBoards EvidenceBoard[]
  evidenceItems EvidenceItem[]
  evidenceLinks EvidenceLink[]
  references Reference[]
  citations  Citation[]
  markerStyles MarkerStyle[]
  llmLogs     LlmLog[]
  auditLogs   AuditLog[]
  reviewRequests ReviewRequest[]
  reviewComments ReviewComment[]
  watches     Watch[]
  notifications Notification[]
  readStates  ReadState[]
  talkThreads TalkThread[]
  talkComments TalkComment[]
  sourceRecords SourceRecord[]
  entityRelations EntityRelation[]
  mapCards    MapCard[]
  cardConnections CardConnection[]
}

model WorkspaceMember {
  id          String         @id @default(cuid())
  workspaceId String
  userId      String
  role        WorkspaceRole
  createdAt   DateTime       @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@unique([workspaceId, userId])
  @@index([userId])
}

model Entity {
  id                 String        @id @default(cuid())
  workspaceId        String
  type               EntityType
  title              String
  aliases            String[]
  tags               String[]
  status             EntityStatus
  worldExistFrom     String?
  worldExistTo       String?
  storyIntroChapterId String?
  parentEntityId     String?
  mainImageId        String?
  summaryMd          String?
  embedding          Unsupported("vector(768)")?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  createdById        String?
  updatedById        String?
  softDeletedAt      DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  storyIntroChapter Chapter? @relation(fields: [storyIntroChapterId], references: [id])
  createdBy User? @relation("EntityCreatedBy", fields: [createdById], references: [id])
  updatedBy User? @relation("EntityUpdatedBy", fields: [updatedById], references: [id])
  parentEntity Entity? @relation("EntityParent", fields: [parentEntityId], references: [id])
  childEntities Entity[] @relation("EntityParent")
  mainImage Asset? @relation("EntityMainImage", fields: [mainImageId], references: [id])

  article   Article?
  overlays  ArticleOverlay[]
  viewpoints Viewpoint[]
  pins      Pin[]
  evidenceItems EvidenceItem[]
  relationsFrom EntityRelation[] @relation("RelationFrom")
  relationsTo   EntityRelation[] @relation("RelationTo")
  talkThreads   TalkThread[]

  @@index([workspaceId, type])
}

model Article {
  entityId       String   @id
  workspaceId    String
  baseRevisionId String?  @unique

  entity       Entity          @relation(fields: [entityId], references: [id])
  workspace    Workspace       @relation(fields: [workspaceId], references: [id])
  baseRevision ArticleRevision? @relation("ArticleBaseRevision", fields: [baseRevisionId], references: [id])
  revisions    ArticleRevision[] @relation("ArticleRevisions")

  @@index([workspaceId])
}

model ArticleOverlay {
  id                   String     @id @default(cuid())
  entityId             String
  workspaceId          String
  viewpointId          String?
  worldFrom            String?
  worldTo              String?
  storyFromChapterId   String?
  storyToChapterId     String?
  truthFlag            TruthFlag
  title                String
  activeRevisionId     String? @unique
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  softDeletedAt        DateTime?

  entity        Entity     @relation(fields: [entityId], references: [id])
  workspace     Workspace  @relation(fields: [workspaceId], references: [id])
  viewpoint     Viewpoint? @relation(fields: [viewpointId], references: [id])
  storyFrom     Chapter?   @relation("OverlayStoryFrom", fields: [storyFromChapterId], references: [id])
  storyTo       Chapter?   @relation("OverlayStoryTo", fields: [storyToChapterId], references: [id])
  activeRevision ArticleRevision? @relation("OverlayActiveRevision", fields: [activeRevisionId], references: [id])
  revisions     ArticleRevision[] @relation("OverlayRevisions")

  @@index([workspaceId, entityId])
}

model ArticleRevision {
  id               String            @id @default(cuid())
  workspaceId      String
  targetType       ArticleTargetType
  articleId        String?
  overlayId        String?
  title            String            @default("")
  bodyMd           String
  changeSummary    String
  embedding        Unsupported("vector(768)")?
  createdAt        DateTime          @default(now())
  createdById      String?
  status           RevisionStatus
  approvedAt       DateTime?
  approvedById     String?
  parentRevisionId String?
  softDeletedAt    DateTime?

  workspace    Workspace  @relation(fields: [workspaceId], references: [id])
  article      Article?   @relation("ArticleRevisions", fields: [articleId], references: [entityId])
  overlay      ArticleOverlay? @relation("OverlayRevisions", fields: [overlayId], references: [id])
  baseOf       Article? @relation("ArticleBaseRevision")
  activeForOverlay ArticleOverlay? @relation("OverlayActiveRevision")
  createdBy    User? @relation("RevisionCreatedBy", fields: [createdById], references: [id])
  approvedBy   User? @relation("RevisionApprovedBy", fields: [approvedById], references: [id])
  parentRevision ArticleRevision? @relation("RevisionParent", fields: [parentRevisionId], references: [id])
  childRevisions  ArticleRevision[] @relation("RevisionParent")

  reviewRequests ReviewRequest[]

  @@index([workspaceId])
}

model Viewpoint {
  id          String        @id @default(cuid())
  workspaceId String
  type        ViewpointType
  entityId    String?
  name        String
  description String?
  createdAt   DateTime      @default(now())
  softDeletedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  entity    Entity?   @relation(fields: [entityId], references: [id])
  overlays  ArticleOverlay[]
  pins      Pin[]
  paths     Path[]
  mapScenes MapScene[]

  @@index([workspaceId])
}

model Timeline {
  id          String       @id @default(cuid())
  workspaceId String
  type        TimelineType
  name        String
  softDeletedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  events    Event[]
  citations Citation[]

  @@index([workspaceId])
}

model Event {
  id              String     @id @default(cuid())
  workspaceId     String
  timelineId      String
  title           String
  eventType       EventType  @default(other)
  worldStart      String?
  worldEnd        String?
  storyOrder      Int?
  storyChapterId  String?
  summaryMd       String?
  involvedEntityIds String[]
  locationMapId   String?
  locationPinId   String?
  locationX       Float?
  locationY       Float?
  markerStyleId   String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  createdById     String?
  updatedById     String?
  softDeletedAt   DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  timeline  Timeline  @relation(fields: [timelineId], references: [id])
  storyChapter Chapter? @relation(fields: [storyChapterId], references: [id])
  locationMap Map? @relation("EventLocationMap", fields: [locationMapId], references: [id])
  locationPin Pin? @relation("EventLocationPin", fields: [locationPinId], references: [id])
  createdBy User? @relation("EventCreatedBy", fields: [createdById], references: [id])
  updatedBy User? @relation("EventUpdatedBy", fields: [updatedById], references: [id])
  markerStyle MarkerStyle? @relation(fields: [markerStyleId], references: [id])

  paths Path[]
  citations Citation[]

  @@index([workspaceId, timelineId])
}

model Era {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  worldStart  String?
  worldEnd    String?
  sortKey     Int
  softDeletedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  mapScenes MapScene[]

  @@index([workspaceId])
}

model Chapter {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  orderIndex  Int
  description String?
  softDeletedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  entities  Entity[]
  overlaysFrom ArticleOverlay[] @relation("OverlayStoryFrom")
  overlaysTo   ArticleOverlay[] @relation("OverlayStoryTo")
  events    Event[]
  pinsFrom  Pin[] @relation("PinStoryFrom")
  pinsTo    Pin[] @relation("PinStoryTo")
  pathsFrom Path[] @relation("PathStoryFrom")
  pathsTo   Path[] @relation("PathStoryTo")
  mapScenes MapScene[]

  @@index([workspaceId])
}

model Map {
  id          String   @id @default(cuid())
  workspaceId String
  title       String
  parentMapId String?
  imageAssetId String?
  crs         String   @default("simple")
  bounds      Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?
  updatedById String?
  softDeletedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  parent    Map?      @relation("MapParent", fields: [parentMapId], references: [id])
  children  Map[]     @relation("MapParent")
  imageAsset Asset?   @relation(fields: [imageAssetId], references: [id])
  createdBy User? @relation("MapCreatedBy", fields: [createdById], references: [id])
  updatedBy User? @relation("MapUpdatedBy", fields: [updatedById], references: [id])

  pins  Pin[]
  paths Path[]
  events Event[] @relation("EventLocationMap")
  layers MapLayer[]
  scenes MapScene[]
  citations Citation[]
  mapCards MapCard[]
  cardConnections CardConnection[]

  @@index([workspaceId])
}

model MapLayer {
  id            String   @id @default(cuid())
  workspaceId   String
  mapId         String
  name          String
  description   String?
  color         String?
  sortIndex     Int?
  isDefault     Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  softDeletedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  map       Map       @relation(fields: [mapId], references: [id])
  pins      Pin[]
  paths     Path[]

  @@index([workspaceId, mapId])
}

model MapScene {
  id            String   @id @default(cuid())
  workspaceId   String
  mapId         String
  name          String
  description   String?
  chapterId     String?
  eraId         String?
  viewpointId   String?
  state         Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  softDeletedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  map       Map       @relation(fields: [mapId], references: [id])
  chapter   Chapter?  @relation(fields: [chapterId], references: [id])
  era       Era?      @relation(fields: [eraId], references: [id])
  viewpoint Viewpoint? @relation(fields: [viewpointId], references: [id])

  @@index([workspaceId, mapId])
}

model Pin {
  id                String    @id @default(cuid())
  mapId             String
  workspaceId       String
  x                 Float
  y                 Float
  entityId          String?
  locationType      LocationType @default(other)
  worldFrom         String?
  worldTo           String?
  storyFromChapterId String?
  storyToChapterId   String?
  viewpointId       String?
  truthFlag         TruthFlag
  label             String?
  iconKey           String?
  markerShape       MarkerShape?
  markerColor       String?
  markerStyleId     String?
  layerId           String?
  softDeletedAt     DateTime?

  map        Map       @relation(fields: [mapId], references: [id])
  workspace  Workspace @relation(fields: [workspaceId], references: [id])
  entity     Entity?   @relation(fields: [entityId], references: [id])
  viewpoint  Viewpoint? @relation(fields: [viewpointId], references: [id])
  markerStyle MarkerStyle? @relation(fields: [markerStyleId], references: [id])
  layer      MapLayer? @relation(fields: [layerId], references: [id])
  storyFrom  Chapter?  @relation("PinStoryFrom", fields: [storyFromChapterId], references: [id])
  storyTo    Chapter?  @relation("PinStoryTo", fields: [storyToChapterId], references: [id])

  events Event[] @relation("EventLocationPin")

  @@index([workspaceId, mapId])
}

model Path {
  id                String   @id @default(cuid())
  mapId             String
  workspaceId       String
  polyline          Json
  worldFrom         String?
  worldTo           String?
  storyFromChapterId String?
  storyToChapterId   String?
  viewpointId       String?
  truthFlag         TruthFlag
  arrowStyle        ArrowStyle
  strokeColor       String?
  strokeWidth       Int?
  relatedEntityIds  String[]
  relatedEventId    String?
  markerStyleId     String?
  layerId           String?
  softDeletedAt     DateTime?

  map        Map       @relation(fields: [mapId], references: [id])
  workspace  Workspace @relation(fields: [workspaceId], references: [id])
  viewpoint  Viewpoint? @relation(fields: [viewpointId], references: [id])
  storyFrom  Chapter?  @relation("PathStoryFrom", fields: [storyFromChapterId], references: [id])
  storyTo    Chapter?  @relation("PathStoryTo", fields: [storyToChapterId], references: [id])
  relatedEvent Event?  @relation(fields: [relatedEventId], references: [id])
  markerStyle MarkerStyle? @relation(fields: [markerStyleId], references: [id])
  layer      MapLayer? @relation(fields: [layerId], references: [id])

  @@index([workspaceId, mapId])
}

model Asset {
  id              String    @id @default(cuid())
  workspaceId     String
  kind            AssetKind
  storageKey      String
  mimeType        String
  size            Int
  width           Int?
  height          Int?
  createdAt       DateTime  @default(now())
  createdById     String?
  sourceUrl       String?
  author          String?
  licenseId       String?
  licenseUrl      String?
  attributionText String?
  retrievedAt     DateTime?
  softDeletedAt   DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  createdBy User? @relation("AssetCreatedBy", fields: [createdById], references: [id])
  maps      Map[]
  evidenceItems EvidenceItem[]
  references Reference[]
  entityMainImages Entity[] @relation("EntityMainImage")

  @@index([workspaceId])
}

model MarkerStyle {
  id           String       @id @default(cuid())
  workspaceId  String
  name         String
  target       MarkerTarget
  eventType    EventType?
  locationType LocationType?
  shape        MarkerShape
  color        String
  iconKey      String?
  createdAt    DateTime     @default(now())
  softDeletedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  pins      Pin[]
  events    Event[]
  paths     Path[]

  @@index([workspaceId, target])
}

model EvidenceBoard {
  id            String   @id @default(cuid())
  workspaceId   String
  name          String
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  softDeletedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  items     EvidenceItem[]
  links     EvidenceLink[]
  citations Citation[]

  @@index([workspaceId])
}

model EvidenceItem {
  id            String           @id @default(cuid())
  workspaceId   String
  boardId       String
  type          EvidenceItemType
  title         String?
  content       String?
  url           String?
  entityId      String?
  assetId       String?
  referenceId   String?
  x             Float
  y             Float
  width         Float?
  height        Float?
  rotation      Float?
  zIndex        Int?
  data          Json?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  softDeletedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  board     EvidenceBoard @relation(fields: [boardId], references: [id])
  entity    Entity?   @relation(fields: [entityId], references: [id])
  asset     Asset?    @relation(fields: [assetId], references: [id])
  reference Reference? @relation(fields: [referenceId], references: [id])
  citations Citation[]
  linksFrom EvidenceLink[] @relation("EvidenceLinkFrom")
  linksTo   EvidenceLink[] @relation("EvidenceLinkTo")

  @@index([workspaceId, boardId])
}

model EvidenceLink {
  id            String            @id @default(cuid())
  workspaceId   String
  boardId       String
  fromItemId    String
  toItemId      String
  label         String?
  style         EvidenceLinkStyle @default(line)
  data          Json?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  softDeletedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  board     EvidenceBoard @relation(fields: [boardId], references: [id])
  fromItem  EvidenceItem @relation("EvidenceLinkFrom", fields: [fromItemId], references: [id])
  toItem    EvidenceItem @relation("EvidenceLinkTo", fields: [toItemId], references: [id])

  @@index([workspaceId, boardId])
}

model Reference {
  id              String        @id @default(cuid())
  workspaceId     String
  type            ReferenceType
  title           String
  author          String?
  year            String?
  publisher       String?
  sourceUrl       String?
  summary         String?
  notes           String?
  tags            String[]
  assetId         String?
  licenseId       String?
  licenseUrl      String?
  attributionText String?
  retrievedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  softDeletedAt   DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  asset     Asset?    @relation(fields: [assetId], references: [id])
  citations Citation[]
  evidenceItems EvidenceItem[]

  @@index([workspaceId])
}

model Citation {
  id            String             @id @default(cuid())
  workspaceId   String
  referenceId   String
  targetType    CitationTargetType
  targetId      String
  quote         String?
  locator       String?
  note          String?
  createdAt     DateTime           @default(now())
  softDeletedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  reference Reference @relation(fields: [referenceId], references: [id])
  board     EvidenceBoard? @relation(fields: [evidenceBoardId], references: [id])
  evidenceBoardId String?
  evidenceItem EvidenceItem? @relation(fields: [evidenceItemId], references: [id])
  evidenceItemId String?
  event    Event? @relation(fields: [eventId], references: [id])
  eventId  String?
  timeline Timeline? @relation(fields: [timelineId], references: [id])
  timelineId String?
  map      Map? @relation(fields: [mapId], references: [id])
  mapId    String?

  @@index([workspaceId, targetType, targetId])
}

model LlmLog {
  id          String       @id @default(cuid())
  workspaceId String?
  userId      String?
  provider    LlmProvider
  input       Json
  output      Json?
  status      String
  createdAt   DateTime     @default(now())

  workspace Workspace? @relation(fields: [workspaceId], references: [id])
  user      User?      @relation(fields: [userId], references: [id])

  @@index([workspaceId])
}

model AuditLog {
  id          String   @id @default(cuid())
  workspaceId String
  actorUserId String
  action      String
  targetType  String
  targetId    String
  meta        Json?
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  actorUser User @relation("AuditActor", fields: [actorUserId], references: [id])

  @@index([workspaceId, targetType, targetId])
}

model ReviewRequest {
  id           String       @id @default(cuid())
  workspaceId  String
  revisionId   String
  requestedById String
  requestedAt  DateTime     @default(now())
  status       ReviewStatus

  workspace  Workspace @relation(fields: [workspaceId], references: [id])
  revision   ArticleRevision @relation(fields: [revisionId], references: [id])
  requestedBy User @relation("ReviewRequestedBy", fields: [requestedById], references: [id])
  assignments ReviewAssignment[]
  comments    ReviewComment[]

  @@index([workspaceId, status])
}

model ReviewAssignment {
  id              String   @id @default(cuid())
  reviewRequestId String
  reviewerId      String
  assignedAt      DateTime @default(now())

  reviewRequest ReviewRequest @relation(fields: [reviewRequestId], references: [id])
  reviewer      User          @relation(fields: [reviewerId], references: [id])

  @@unique([reviewRequestId, reviewerId])
}

model ReviewComment {
  id              String   @id @default(cuid())
  reviewRequestId String
  userId          String
  bodyMd          String
  createdAt       DateTime @default(now())

  reviewRequest ReviewRequest @relation(fields: [reviewRequestId], references: [id])
  user          User          @relation(fields: [userId], references: [id])
  workspace     Workspace?    @relation(fields: [workspaceId], references: [id])
  workspaceId   String?
}

model Watch {
  id          String   @id @default(cuid())
  userId      String
  workspaceId String
  targetType  String
  targetId    String
  notifyInApp Boolean  @default(true)
  notifyEmail Boolean  @default(false)
  createdAt   DateTime @default(now())

  user      User      @relation(fields: [userId], references: [id])
  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId, targetType, targetId])
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  workspaceId String
  type        String
  payload     Json
  createdAt   DateTime @default(now())
  readAt      DateTime?

  user      User      @relation(fields: [userId], references: [id])
  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@index([userId, readAt])
}

model ReadState {
  userId      String
  workspaceId String
  targetType  String
  targetId    String
  lastReadAt  DateTime
  lastReadRevisionId String?

  user      User      @relation(fields: [userId], references: [id])
  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@id([userId, workspaceId, targetType, targetId])
}

model TalkThread {
  id            String   @id @default(cuid())
  workspaceId   String
  entityId      String
  title         String
  createdById   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  softDeletedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  entity    Entity    @relation(fields: [entityId], references: [id])
  createdBy User?     @relation("TalkThreadCreatedBy", fields: [createdById], references: [id])
  comments  TalkComment[]

  @@index([workspaceId, entityId])
}

model TalkComment {
  id            String   @id @default(cuid())
  workspaceId   String
  threadId      String
  bodyMd        String
  createdAt     DateTime @default(now())
  createdById   String?
  softDeletedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  thread    TalkThread @relation(fields: [threadId], references: [id])
  createdBy User?     @relation("TalkCommentCreatedBy", fields: [createdById], references: [id])

  @@index([workspaceId, threadId])
}

model SourceRecord {
  id              String           @id @default(cuid())
  workspaceId     String
  targetType      SourceTargetType
  targetId        String
  sourceUrl       String
  title           String?
  author          String?
  licenseId       String?
  licenseUrl      String?
  attributionText String?
  retrievedAt     DateTime
  note            String?
  createdAt       DateTime         @default(now())
  createdById     String?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  createdBy User? @relation("SourceRecordCreatedBy", fields: [createdById], references: [id])

  @@index([workspaceId, targetType, targetId])
}

enum RelationType {
  member_of
  allied_with
  enemy_of
  parent_of
  child_of
  sibling_of
  located_in
  owns
  created_by
  participated_in
  related_to
  custom
}

model EntityRelation {
  id            String       @id @default(cuid())
  workspaceId   String
  fromEntityId  String
  toEntityId    String
  relationType  RelationType
  customLabel   String?
  description   String?
  worldFrom     String?
  worldTo       String?
  storyFromChapterId String?
  storyToChapterId   String?
  createdAt     DateTime     @default(now())
  softDeletedAt DateTime?

  workspace  Workspace @relation(fields: [workspaceId], references: [id])
  fromEntity Entity    @relation("RelationFrom", fields: [fromEntityId], references: [id])
  toEntity   Entity    @relation("RelationTo", fields: [toEntityId], references: [id])

  @@index([workspaceId, fromEntityId])
  @@index([workspaceId, toEntityId])
}



enum MapCardType {
  entity
  article
  event
  note
  image
}

enum CardConnectionType {
  timeline
  causal
  reference
  spatial
}

model MapCard {
  id          String      @id @default(cuid())
  workspaceId String
  mapId       String
  type        MapCardType
  title       String
  content     String?
  x           Float
  y           Float
  width       Float?
  height      Float?
  rotation    Float?
  zIndex      Int?
  entityId    String?
  articleId   String?
  eventId     String?
  assetId     String?
  data        Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  softDeletedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  map       Map       @relation(fields: [mapId], references: [id])
  connectionsFrom CardConnection[] @relation("CardConnectionFrom")
  connectionsTo   CardConnection[] @relation("CardConnectionTo")

  @@index([workspaceId, mapId])
}

model CardConnection {
  id          String             @id @default(cuid())
  workspaceId String
  mapId       String
  fromCardId  String
  toCardId    String
  type        CardConnectionType @default(timeline)
  label       String?
  style       String?
  data        Json?
  createdAt   DateTime           @default(now())
  softDeletedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  map       Map       @relation(fields: [mapId], references: [id])
  fromCard  MapCard   @relation("CardConnectionFrom", fields: [fromCardId], references: [id])
  toCard    MapCard   @relation("CardConnectionTo", fields: [toCardId], references: [id])

  @@index([workspaceId, mapId])
}
